<%- include('partials/page-top', {
  title: 'Team Builder',
  extraHead: '<script defer src="/js/team-builder.js"></script>'
}) %>
<section class="builder">
  <div class="builder-summary">
    <h1>Draft your XI</h1>
    <p>Budget: £<%= budget %>m · Pick exactly 11 players</p>
    <% if (error) { %>
      <div class="error"><%= error %></div>
    <% } %>
    <form method="POST" action="/team-builder" id="team-form">
      <label>
        Team name
        <input type="text" name="teamName" value="<%= teamName %>" required />
      </label>
      <div class="selection-stats">
        <div>
          <p>Players picked</p>
          <span class="player-count-value"><strong id="selected-count"><%= selectedIds.length %></strong> / 11</span>
        </div>
        <div>
          <p>Spend</p>
          <strong>£<span id="spend-total">0.0</span>m</strong>
        </div>
        <div>
          <p>Budget left</p>
          <strong>£<span id="budget-left">0.0</span>m</strong>
        </div>
      </div>
      <button type="submit" class="button" id="save-button" disabled>Save squad</button>
    </form>
  </div>

  <div class="player-list" data-budget="<%= budget %>">
    <%
      const positionGroups = {
        'GK': { name: 'Goalkeeper', players: [] },
        'DF': { name: 'Defender', players: [] },
        'MF': { name: 'Midfielder', players: [] },
        'FW': { name: 'Forward', players: [] }
      };
      
      players.forEach((player) => {
        if (positionGroups[player.position]) {
          positionGroups[player.position].players.push(player);
        }
      });
      
      const positionOrder = ['GK', 'DF', 'MF', 'FW'];
    %>
    <% positionOrder.forEach((pos) => { %>
      <% if (positionGroups[pos].players.length > 0) { %>
        <div class="position-group" data-position="<%= pos %>">
          <h2 class="position-group-title">
            <%= positionGroups[pos].name %>
            <span class="position-count" data-position="<%= pos %>">
              <span class="position-count-current" id="count-<%= pos.toLowerCase() %>">0</span>
              <span class="position-count-separator">/</span>
              <span class="position-count-max"><%= pos === 'GK' ? '1' : '4' %></span>
            </span>
          </h2>
          <div class="position-group-players">
            <% positionGroups[pos].players.forEach((player) => { %>
              <label class="player-option">
                <input
                  type="checkbox"
                  name="playerIds"
                  value="<%= player.id %>"
                  <%= selectedIds.includes(player.id) ? 'checked' : '' %>
                  data-value="<%= player.value %>"
                  data-position="<%= player.position %>"
                  form="team-form"
                />
                <img src="<%= player.photoUrl %>" alt="<%= player.name %>" loading="lazy" />
                <div>
                  <h3><%= player.name %></h3>
                  <p><strong><%= player.position %></strong> · <%= player.club %></p>
                  <p>Value: £<%= player.value %>m</p>
                  <p class="stat-line">
                    Goals <%= player.stats.goals %> · Assists <%= player.stats.assists %> · Caps
                    <%= player.stats.caps %>
                  </p>
                </div>
              </label>
            <% }) %>
          </div>
        </div>
      <% } %>
    <% }) %>
  </div>
</section>
<%- include('partials/page-bottom') %>

